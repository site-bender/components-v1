---
import generateShortId from "../../utilities/generateShortId"
import mapAttributes from "../../utilities/mapAttributes"
import MonthSelect from "../elements/MonthSelect/index.astro"
import YearInput from "../elements/YearInput/index.astro"
import type { PlainYearMonthField as Props } from "../../types/form"
import type { HTMLAttributes } from "../../types/html"
import { Temporal } from "@js-temporal/polyfill"

const {
	["aria-live"]: live = "assertive",
	calendar = "iso8601",
	disabled,
	field = "year-month-field",
	form,
	format,
	group = {},
	help = {},
	id = generateShortId(),
	includeNull,
	label = "Year and month",
	legend = {},
	message,
	month,
	monthAttrs = {},
	monthCode,
	months,
	name = "plainYearMonth",
	outer = {},
	plainYearMonth,
	required,
	tag = {},
	year,
	yearAttrs = {},
	years,
} = Astro.props

const yearAttributes = mapAttributes(yearAttrs as HTMLAttributes, [])
const monthAttributes = mapAttributes(monthAttrs as HTMLAttributes, [])
const groupAttrs = mapAttributes(group, ["sb-group"])
const helpAttrs = mapAttributes(help, ["sb-help"])
const legendAttrs = mapAttributes(legend, ["sb-label"])
const outerAttrs = mapAttributes(outer, [
	"sb-field",
	"sb-plain-year-month-field",
])
const tagAttrs = mapAttributes(tag, ["sb-label-tag"])

const val: Temporal.PlainYearMonthLike | undefined =
	plainYearMonth || (year && (month || monthCode))
		? {
				calendar,
				...(monthCode ? { monthCode } : { month }),
				...(era ? { era, eraYear } : { year }),
		  }
		: undefined

const value = val && Temporal.PlainYearMonth.from(val)

const hlp = (await Astro.slots.render("message")) || message
const helpId = `${id}_help`
const lbl = (await Astro.slots.render("default")) || label
const legendId = `${id}_legend`
const monthId = `${id}-month`
const monthName = `${name}:month`
const yearId = `${id}-year`
const yearName = `${name}:year`
const req = required ? { "data-sb-required": "" } : {}
const opt = required ? {} : { "data-sb-optional": "" }
---

<fieldset
	{...outerAttrs}
	data-sb-field={field}
	{...req}
	{disabled}
	{form}
	{id}
	{name}
>
	<legend {...legendAttrs} data-sb-field-label={field} id={legendId}>
		<span
			{...tagAttrs}
			data-sb-field-label-tag={field}
			{...opt}
			set:html={lbl}
		/>
		<span
			{...helpAttrs}
			aria-live={live}
			data-sb-field-help={field}
			id={helpId}
			role="status"
			set:html={hlp}
		/>
	</legend>
	<div {...groupAttrs} data-sb-field-group={field}>
		<label data-sb-label-time={field} for={yearId}>
			<span id={`${yearId}:label`}>Year</span>
			<YearInput
				{...yearAttributes}
				data-sb-input-year={field}
				{form}
				id={yearId}
				labelledBy={`${legendId} ${yearId}:label`}
				name={yearName}
				{required}
				value={value?.year}
				years={years}
			/>
		</label>
		<label data-sb-label-month={field} for={monthId}>
			<span id={`${monthId}:label`}>Month</span>
			<MonthSelect
				{...monthAttributes}
				data-sb-select-month={field}
				{form}
				{format}
				id={monthId}
				{includeNull}
				labelledBy={`${legendId} ${monthId}:label`}
				name={monthName}
				{required}
				value={value?.month}
				months={months}
			/>
		</label>
	</div>
</fieldset>
