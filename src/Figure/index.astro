---
import Microdata from "../Microdata/index.astro"
import generateShortId from "../utilities/generateShortId"
import mapAttributes from "../utilities/mapAttributes"
import type { FigureProps as Props } from "../types"
import "./index.css"

const {
	caption,
	figcaption = {},
	id = generateShortId(),
	index,
	isIndexed,
	properties,
	...attrs
} = Astro.props

const figcaptionAttrs = mapAttributes(figcaption, ["sb-figure-figcaption"])
const wrapperAttrs = mapAttributes(attrs, ["sb-figure"])

const indexed = isIndexed ? { class: "indexed" } : {}
const cap = caption ? caption : await Astro.slots.render("caption")

const useMicrodata = Boolean(import.meta.env.USE_MICRODATA)
---

{
	useMicrodata ? (
			<Microdata
				{...wrapperAttrs}
				as="figure"
				data-sb-figure
				{id}
				{...indexed}
				{properties}
			>
				{
					cap && (
						<figcaption
							{...figcaptionAttrs}
							data-sb-figure="figcaption"
						>
							{index ? `Figure ${index}: ` : ""}
							<Fragment set:html={cap} />
						</figcaption>
					)
				}
				<slot />
			</Microdata>
		) : (
			<figure
				{...wrapperAttrs}
				data-sb-figure
				{id}
				{...indexed}
			>
				{
					cap && (
						<figcaption
							{...figcaptionAttrs}
							data-sb-figure="figcaption"
						>
							{index ? `Figure ${index}: ` : ""}
							<Fragment set:html={cap} />
						</figcaption>
					)
				}
				<slot />
			</figure>
	)
}
