---
import Microdata from "../../Microdata/index.astro";
import createClassList from "../../utilities/createClassList";
import mapAttributes from "../../utilities/mapAttributes"
import mapDataset from "../../utilities/mapDataset";
import type { InstantProps as Props } from "../../types";
import { DEFAULT_LOCALES } from "../../constants";
import { Intl, Temporal } from "@js-temporal/polyfill";

const {
	["class:list"]: classList = [],
	dataset,
	instant,
	itemprop,
	itemtype,
	locales = DEFAULT_LOCALES,
	microdata = {},
	options = {},
	properties,
	type,
	...attrs
} = Astro.props;

const {
	["class:list"]: microdataClassList = [],
	dataset: microdataDataset = {},
	...microdataAttrs
} = microdata;

const value =
	instant instanceof Temporal.ZonedDateTime
		? instant.toInstant()
		: typeof instant === "string"
		? Temporal.Instant.from(instant)
		: instant;

const label = new Intl.DateTimeFormat(locales, options).format(value);

const useMicrodata = Boolean(import.meta.env.USE_MICRODATA);
const meta = {
	type,
	...(itemprop ? { [itemprop]: value.toString() } : {}),
	...properties,
};
---

{
	useMicrodata && itemtype ? (
		<Microdata
			{...microdataAttrs}
			class:list={createClassList("sb-instant-metadata", microdataClassList)}
			{...mapDataset(microdataDataset)}
			data-sb-instant="microdata"
			properties={meta}
		/>
	) : null
}
<time
	{...attrs}
	class:list={createClassList("sb-instant", classList)}
	{...mapDataset(dataset)}
	data-sb-instant
	datetime={value.toString()}
>
	{label}
</time>
